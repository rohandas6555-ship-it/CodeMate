<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CodeMate — Universal Coding Assistant</title>
    <meta name="description" content="AI-Powered Coding Assistant for DSA, Web Dev, and Debugging.">

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.0.0/dist/mermaid.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#09090b',
                        surface: '#18181b',
                        surfaceHover: '#27272a',
                        accent: '#3b82f6',
                        border: '#27272a'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'cursor': 'cursor .75s step-end infinite',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        cursor: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-15px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        :root { color-scheme: dark; }
        body { 
            background-color: #09090b; 
            color: #e4e4e7; 
            overscroll-behavior-y: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* Prose / Markdown Styles */
        .prose p { margin-bottom: 0.75rem; line-height: 1.7; color: #d4d4d8; font-size: 0.95rem; }
        @media (min-width: 768px) { .prose p { font-size: 1rem; } }
        
        .prose h1, .prose h2, .prose h3, .prose h4 { color: #f4f4f5; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; letter-spacing: -0.015em; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose ul, .prose ol { padding-left: 1.25rem; margin-bottom: 1rem; list-style-position: outside; color: #d4d4d8; }
        .prose li { margin-bottom: 0.375rem; }
        .prose li::marker { color: #52525b; }
        .prose a { color: #60a5fa; text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s; word-break: break-all; }
        .prose a:hover { border-bottom-color: #60a5fa; }
        .prose blockquote { border-left: 3px solid #3b82f6; padding-left: 1rem; font-style: italic; color: #a1a1aa; margin: 1rem 0; }
        .prose code:not(pre code) { background: #27272a; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.85em; font-family: 'JetBrains Mono', monospace; color: #e4e4e7; }
        
        /* Table Styles */
        .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
        .prose th { text-align: left; padding: 0.75rem; border-bottom: 1px solid #3f3f46; color: #fff; font-weight: 600; }
        .prose td { padding: 0.75rem; border-bottom: 1px solid #27272a; color: #a1a1aa; }

        /* Code Block Container */
        .code-wrapper { margin: 1.25rem 0; border: 1px solid #27272a; border-radius: 0.75rem; overflow: hidden; background: #000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .code-header { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 1rem; background: #18181b; border-bottom: 1px solid #27272a; }
        .lang-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; text-transform: uppercase; color: #a1a1aa; font-weight: 500; }
        .copy-btn { cursor: pointer; display: flex; align-items: center; gap: 0.35rem; color: #71717a; transition: color 0.2s; font-size: 0.75rem; font-weight: 500; }
        .copy-btn:hover { color: #e4e4e7; }
        pre { margin: 0; padding: 1.25rem; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; line-height: 1.6; }

        /* Background Animation */
        .hero-bg {
            background-image: linear-gradient(rgba(39, 39, 42, 0.5) 1px, transparent 1px),
            linear-gradient(90deg, rgba(39, 39, 42, 0.5) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 30%, transparent 70%);
            -webkit-mask-image: radial-gradient(circle at center, black 30%, transparent 70%);
            transform: perspective(800px) rotateX(20deg) scale(1.2);
            animation: grid-move 40s linear infinite;
        }
        @media (max-width: 768px) { .hero-bg { opacity: 0.15; animation: none; transform: none; } }
        @keyframes grid-move { 0% { background-position: 0 0; } 100% { background-position: 0 40px; } }

        /* Loading Dots */
        .typing-dot { width: 6px; height: 6px; background: #9ca3af; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Utility */
        .glow-text { text-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
        .safe-pb { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
    </style>
</head>

<body class="flex flex-col h-[100dvh] overflow-hidden text-base selection:bg-blue-500/30">

    <header class="w-full px-4 py-3 md:py-4 flex justify-between items-center z-50 border-b border-white/5 bg-bg/80 backdrop-blur-md shrink-0">
        <div class="flex items-center gap-2.5">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center text-white font-bold font-mono text-sm shadow-lg shadow-blue-500/20">>_</div>
            <span class="font-semibold text-white tracking-tight text-lg">CodeMate</span>
        </div>
        <div class="text-[10px] md:text-xs font-mono text-gray-400 bg-surface border border-border px-2 py-1 rounded-md shadow-sm">v3.1 Stable</div>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto scroll-smooth w-full relative">
        <div class="max-w-3xl mx-auto w-full flex flex-col min-h-full px-4 pb-4">

            <div id="hero" class="relative flex flex-col items-center justify-center flex-1 py-12 md:py-20 transition-all duration-500 ease-in-out">
                
                <div class="absolute inset-0 -z-10 overflow-hidden pointer-events-none">
                    <div class="absolute inset-[-50%] w-[200%] h-[200%] hero-bg opacity-30"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[200px] h-[200px] md:w-[500px] md:h-[500px] bg-blue-600/10 rounded-full blur-[100px]"></div>
                </div>

                <div class="absolute inset-0 pointer-events-none -z-10 overflow-hidden hidden md:block">
                    <i class="ri-reactjs-line absolute top-[20%] left-[10%] text-4xl text-blue-500/10 animate-float" style="animation-delay: 0s;"></i>
                    <i class="ri-code-s-slash-line absolute top-[60%] left-[5%] text-6xl text-purple-500/10 animate-float" style="animation-delay: 2s;"></i>
                    <i class="ri-database-2-line absolute top-[15%] right-[15%] text-5xl text-green-500/10 animate-float" style="animation-delay: 4s;"></i>
                </div>

                <div class="z-10 flex flex-col items-center text-center w-full max-w-2xl">
                    <div class="mb-6 animate-fade-in opacity-0" style="animation-delay: 0.1s;">
                        <span class="px-3 py-1 rounded-full border border-blue-500/20 bg-blue-500/5 text-blue-400 text-[10px] md:text-xs font-mono uppercase tracking-wider font-medium shadow-sm">
                            <i class="ri-sparkling-fill mr-1 text-blue-500"></i> AI Engineering Partner
                        </span>
                    </div>

                    <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-b from-white via-white to-gray-400 mb-6 glow-text tracking-tight animate-fade-in opacity-0 leading-[1.1]" style="animation-delay: 0.2s;">
                        Build faster with <br class="hidden md:block"/> <span class="text-blue-500">Intelligence.</span>
                    </h1>

                    <p class="text-gray-400 text-sm md:text-lg max-w-md md:max-w-xl mx-auto mb-10 animate-fade-in opacity-0 leading-relaxed" style="animation-delay: 0.3s;">
                        Generate boilerplate, debug complex logic, and visualize architectures instantly.
                    </p>

                    <div class="w-full bg-black/40 backdrop-blur-sm border border-white/10 rounded-xl shadow-2xl overflow-hidden mb-10 text-left font-mono text-[11px] md:text-sm transform transition hover:scale-[1.01] duration-500 animate-fade-in opacity-0" style="animation-delay: 0.4s;">
                        <div class="bg-white/5 px-4 py-2.5 border-b border-white/5 flex justify-between items-center">
                            <div class="flex gap-2">
                                <div class="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-green-500/50"></div>
                            </div>
                            <div class="text-gray-600">terminal</div>
                        </div>
                        <div class="p-5 space-y-2">
                            <div class="flex items-center">
                                <span class="text-blue-400 mr-2">➜</span> <span class="text-white">codemate start</span>
                            </div>
                            <div class="text-gray-500">
                                > System online.<br>
                                > How can I help you today?
                            </div>
                            <div class="flex items-center pt-1">
                                <span class="text-blue-400 mr-2">➜</span>
                                <span class="text-white">Explain </span>
                                <span class="flex ml-2">
                                    <span id="typewriter" class="text-yellow-400 font-bold"></span>
                                    <span class="animate-cursor inline-block w-2 h-4 md:w-2.5 md:h-5 bg-blue-500 ml-1"></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 w-full animate-fade-in opacity-0" style="animation-delay: 0.5s;">
                        <button onclick="fillInput('Generate a Next.js 14 Dashboard Layout')" class="p-3 rounded-xl bg-surface border border-border hover:border-blue-500/40 hover:bg-surfaceHover transition-all group text-left">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="ri-layout-masonry-fill text-blue-400"></i>
                                <span class="text-xs font-semibold text-gray-300">Frontend</span>
                            </div>
                            <div class="text-[10px] text-gray-500 truncate">Generate Next.js Layout</div>
                        </button>
                        <button onclick="fillInput('Explain QuickSort Time Complexity')" class="p-3 rounded-xl bg-surface border border-border hover:border-green-500/40 hover:bg-surfaceHover transition-all group text-left">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="ri-speed-line text-green-400"></i>
                                <span class="text-xs font-semibold text-gray-300">Algorithms</span>
                            </div>
                            <div class="text-[10px] text-gray-500 truncate">Explain QuickSort</div>
                        </button>
                        <button onclick="fillInput('Create a Docker Compose for Redis and Node')" class="p-3 rounded-xl bg-surface border border-border hover:border-purple-500/40 hover:bg-surfaceHover transition-all group text-left col-span-2 md:col-span-1">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="ri-server-line text-purple-400"></i>
                                <span class="text-xs font-semibold text-gray-300">DevOps</span>
                            </div>
                            <div class="text-[10px] text-gray-500 truncate">Docker Compose Setup</div>
                        </button>
                    </div>
                </div>
            </div>

            <div id="messages-list" class="flex flex-col gap-6 pt-6 pb-4"></div>

            <div id="loader" class="hidden py-4 animate-fade-in">
                <div class="flex gap-4">
                    <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center flex-shrink-0"><i class="ri-robot-2-fill text-white"></i></div>
                    <div class="flex items-center gap-1.5 h-8">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="w-full bg-bg/95 backdrop-blur border-t border-white/5 z-40 shrink-0 safe-pb">
        <div class="max-w-3xl mx-auto px-2 md:px-4 py-3 relative">
            
            <div id="file-preview" class="hidden absolute -top-14 left-4 bg-surface border border-border px-3 py-2 rounded-lg text-xs text-gray-300 items-center gap-2 shadow-xl animate-fade-in">
                <div class="w-6 h-6 rounded bg-blue-500/20 flex items-center justify-center text-blue-400"><i class="ri-file-code-line"></i></div>
                <span id="filename" class="max-w-[150px] truncate font-mono">file.js</span>
                <button onclick="clearFile()" class="ml-2 hover:text-red-400 p-1 rounded-full hover:bg-white/5 transition"><i class="ri-close-line"></i></button>
            </div>

            <div class="bg-surface rounded-2xl border border-border flex items-end p-1.5 shadow-lg focus-within:ring-1 focus-within:ring-blue-500/50 focus-within:border-blue-500/50 transition-all">
                
                <button onclick="document.getElementById('file-upload').click()" class="p-2.5 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition shrink-0 active:scale-95 group" title="Attach File">
                    <i class="ri-attachment-2 text-lg group-hover:text-blue-400 transition-colors"></i>
                </button>
                <input type="file" id="file-upload" class="hidden" onchange="handleFile(this)">

                <textarea id="user-input" rows="1" class="w-full bg-transparent text-gray-100 placeholder-gray-500 py-3 px-2 max-h-[150px] resize-none focus:outline-none font-sans text-[15px] leading-relaxed" placeholder="Ask anything about code..."></textarea>

                <button onclick="sendMessage()" id="send-btn" class="p-2.5 m-0.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl transition shadow-lg shrink-0 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="ri-arrow-up-line font-bold text-lg"></i>
                </button>
            </div>
            
            <div class="text-center mt-2">
                <p class="text-[10px] text-gray-600">AI can make mistakes. Review generated code.</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
        
        marked.use({
            gfm: true,
            breaks: true,
        });

        // --- TYPEWRITER ---
        const languages = ["React Hooks...", "Python Async...", "Docker Config...", "Rust Macros...", "AWS Lambda..."];
        let langIndex = 0, charIndex = 0, isDeleting = false;

        function typeWriter() {
            const currentLang = languages[langIndex];
            const typeElement = document.getElementById("typewriter");
            if (!typeElement) return;

            typeElement.innerText = isDeleting ? currentLang.substring(0, charIndex--) : currentLang.substring(0, charIndex++);
            
            let speed = isDeleting ? 40 : 80;
            if (!isDeleting && charIndex === currentLang.length + 1) { isDeleting = true; speed = 2500; }
            else if (isDeleting && charIndex === 0) { isDeleting = false; langIndex = (langIndex + 1) % languages.length; }

            setTimeout(typeWriter, speed);
        }
        document.addEventListener("DOMContentLoaded", typeWriter);

        // --- DOM ELEMENTS ---
        const chatContainer = document.getElementById('chat-container');
        const msgList = document.getElementById('messages-list');
        const userInput = document.getElementById('user-input');
        const hero = document.getElementById('hero');
        const loader = document.getElementById('loader');
        let currentFile = null;

        // --- TEXTAREA AUTOSIZE ---
        userInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // --- KEYBOARD HANDLING ---
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { 
                if(window.innerWidth < 768) userInput.blur(); // Close keyboard on mobile
                e.preventDefault(); 
                sendMessage(); 
            }
        });

        function fillInput(text) { 
            userInput.value = text; 
            userInput.dispatchEvent(new Event('input'));
            userInput.focus();
        }

        // --- FILE HANDLING ---
        function handleFile(input) {
            if (input.files[0]) {
                currentFile = input.files[0];
                document.getElementById('file-preview').classList.replace('hidden', 'flex');
                document.getElementById('filename').innerText = currentFile.name;
                userInput.focus();
            }
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('file-preview').classList.replace('flex', 'hidden');
        }

        // --- RENDERING MESSAGES ---
        function appendMessage(role, content) {
            const div = document.createElement('div');
            div.className = "flex gap-4 animate-fade-in group";
            
            const avatarHtml = role === 'ai' 
                ? '<div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center flex-shrink-0 mt-1 shadow-lg shadow-blue-900/20"><i class="ri-robot-2-fill text-white text-sm"></i></div>'
                : '<div class="w-8 h-8 rounded-lg bg-surface border border-border flex items-center justify-center flex-shrink-0 mt-1"><i class="ri-user-3-fill text-gray-400 text-sm"></i></div>';

            const msgContent = document.createElement('div');
            msgContent.className = "flex-1 min-w-0 pt-1";

            if (role === 'ai') {
                msgContent.className += " prose prose-invert max-w-none";
                
                // 1. Sanitize & Parse Markdown
                const cleanHtml = DOMPurify.sanitize(marked.parse(content));
                msgContent.innerHTML = cleanHtml;
                
                // 2. Process Code Blocks
                msgContent.querySelectorAll('pre code').forEach((block) => {
                    const rawCode = block.innerText;
                    const langClass = block.className || 'language-text';
                    const lang = langClass.replace('language-', '');

                    // Mermaid Handling
                    if (lang === 'mermaid') {
                        const wrapper = document.createElement('div');
                        wrapper.className = "my-4 overflow-x-auto bg-surface border border-border rounded-lg p-4 text-center";
                        const mermaidId = `mermaid-${Math.random().toString(36).substr(2, 9)}`;
                        wrapper.innerHTML = `<pre class="mermaid" id="${mermaidId}">${rawCode}</pre>`;
                        block.parentElement.replaceWith(wrapper);
                        return;
                    }

                    // Standard Code Block Handling
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-wrapper';
                    
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    header.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="flex gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/50"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/50"></div>
                            </div>
                            <span class="lang-badge ml-2 text-gray-500">${lang}</span>
                        </div>
                        <div class="copy-btn" onclick="copyCode(this)">
                            <i class="ri-file-copy-line"></i> <span>Copy</span>
                        </div>
                        <textarea class="hidden hidden-code">${rawCode}</textarea>
                    `;

                    const pre = document.createElement('pre');
                    const codeEl = document.createElement('code');
                    codeEl.className = langClass;
                    codeEl.textContent = rawCode; // Securely set text content
                    
                    pre.appendChild(codeEl);
                    wrapper.appendChild(header);
                    wrapper.appendChild(pre);
                    block.parentElement.replaceWith(wrapper);
                    
                    // Highlight
                    hljs.highlightElement(codeEl);
                });

                // 3. Render Math
                renderMathInElement(msgContent, {
                    delimiters: [
                        { left: "$$", right: "$$", display: true },
                        { left: "$", right: "$", display: false }
                    ],
                    throwOnError: false
                });
                
                // 4. Run Mermaid
                mermaid.run({ nodes: msgContent.querySelectorAll('.mermaid') });

            } else {
                // User Message
                msgContent.innerHTML = `<p class="whitespace-pre-wrap text-gray-100 bg-surface/50 border border-border inline-block px-4 py-2.5 rounded-2xl rounded-tl-sm">${content}</p>`;
                if (currentFile) {
                    msgContent.innerHTML += `
                        <div class="mt-2 flex items-center gap-2 text-xs text-blue-400 bg-blue-500/10 border border-blue-500/20 px-3 py-2 rounded-lg w-fit">
                            <i class="ri-file-code-line text-lg"></i>
                            <span class="font-mono">${currentFile.name}</span>
                        </div>`;
                }
            }

            div.innerHTML = avatarHtml;
            div.appendChild(msgContent);
            msgList.appendChild(div);
            
            // Smooth scroll
            window.requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // --- UTILS ---
        window.copyCode = function (btn) {
            const area = btn.parentElement.querySelector('.hidden-code');
            if (!area) return;
            navigator.clipboard.writeText(area.value).then(() => {
                const span = btn.querySelector('span');
                const icon = btn.querySelector('i');
                const originalText = span.innerText;
                
                span.innerText = "Copied!";
                icon.className = "ri-check-line text-green-500";
                btn.classList.add('text-green-500');
                
                setTimeout(() => {
                    span.innerText = originalText;
                    icon.className = "ri-file-copy-line";
                    btn.classList.remove('text-green-500');
                }, 2000);
            });
        }

        // --- API HANDLER ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !currentFile) return;

            if (hero) hero.style.display = 'none';
            appendMessage('user', text);
            
            userInput.value = '';
            userInput.style.height = 'auto';
            document.getElementById('send-btn').disabled = true;

            const formData = new FormData();
            formData.append('message', text);
            if (currentFile) formData.append('file', currentFile);
            clearFile();

            loader.classList.remove('hidden');
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // Point this to your actual backend endpoint
                const res = await fetch('/chat', { method: 'POST', body: formData });
                const data = await res.json();
                loader.classList.add('hidden');

                if (data.error) {
                    appendMessage('ai', `**Error:** ${data.error}`);
                } else {
                    appendMessage('ai', data.response);
                }
            } catch (err) {
                loader.classList.add('hidden');
                // Fallback for demo purposes if backend isn't running
                console.error(err);
                appendMessage('ai', `❌ **Connection Error:** \nCould not connect to the backend at \`/chat\`. \n\nEnsure your Python/Node server is running.`);
            } finally {
                document.getElementById('send-btn').disabled = false;
                if(window.innerWidth > 768) userInput.focus();
            }
        }
    </script>
</body>
</html>
