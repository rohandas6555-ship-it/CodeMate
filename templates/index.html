<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CodeMate ‚Äî The Ultimate Universal Coding Assistant</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { bg: '#09090b', surface: '#18181b', accent: '#3b82f6', border: '#27272a' },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-in-out', 'cursor': 'cursor .75s step-end infinite' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        cursor: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #09090b; color: #e4e4e7; overscroll-behavior-y: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }

        /* Typography & Markdown Styles */
        .prose p { margin-bottom: 1rem; line-height: 1.6; color: #d4d4d8; }
        .prose h1, .prose h2, .prose h3 { color: #fff; font-weight: 600; margin-top: 1.5rem; margin-bottom: 1rem; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose ul, .prose ol { padding-left: 1.5rem; margin-bottom: 1rem; list-style-position: outside; }
        .prose li { margin-bottom: 0.5rem; }
        .prose a { color: #3b82f6; text-decoration: none; }
        
        /* Table Styles */
        .prose table { width: 100%; text-align: left; margin: 1rem 0; border-collapse: collapse; font-size: 0.9rem; }
        .prose th { border-bottom: 1px solid #3f3f46; padding: 0.5rem; color: #fff; font-weight: 600; }
        .prose td { border-bottom: 1px solid #27272a; padding: 0.5rem; color: #a1a1aa; }

        /* Code Block Styles */
        .code-container { margin: 1rem 0; border: 1px solid #27272a; border-radius: 8px; overflow: hidden; background: #000; }
        .code-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #18181b; border-bottom: 1px solid #27272a; font-size: 0.75rem; color: #a1a1aa; }
        .copy-btn { cursor: pointer; display: flex; align-items: center; gap: 4px; transition: color 0.2s; }
        .copy-btn:hover { color: #fff; }
        pre { margin: 0; padding: 16px; overflow-x: auto; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }

        /* Loading Animation */
        .typing-dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>

<body class="flex h-[100dvh] flex-col overflow-hidden text-sm md:text-base">

    <header class="w-full p-4 flex justify-between items-center z-20 border-b border-white/5 bg-bg/95 backdrop-blur">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white font-bold font-mono text-base">>_</div>
            <span class="font-semibold text-white tracking-tight text-lg">CodeMate</span>
        </div>
        <div class="text-xs font-mono text-gray-500 bg-surface px-2 py-1 rounded border border-border">v2.1 Stable</div>
    </header>

    <div id="chat-container" class="flex-1 overflow-y-auto scroll-smooth pt-4 pb-4">
        <div class="max-w-3xl mx-auto px-4 w-full flex flex-col min-h-full">

            <div id="hero" class="flex flex-col items-center justify-center flex-1 py-8 transition-opacity duration-500">
                <div class="w-full max-w-lg bg-black border border-border rounded-xl shadow-2xl overflow-hidden mb-8 text-left font-mono text-xs md:text-sm mx-4">
                    <div class="bg-surface px-3 py-2 border-b border-border flex gap-1.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                    </div>
                    <div class="p-4 md:p-6 text-green-400 space-y-2">
                        <div><span class="text-blue-400">user@codemate</span>:~$ init dsa_module</div>
                        <div>> Loading Algorithms... <span class="text-white">Done</span></div>
                        <div class="flex flex-wrap">
                            <span class="text-blue-400">user@codemate</span>:~$ <span class="text-white ml-2 mr-1">Master DSA in </span>
                            <span class="flex">
                                <span id="typewriter" class="text-yellow-400"></span>
                                <span class="animate-cursor inline-block w-2 h-4 bg-white ml-1 align-middle"></span>
                            </span>
                        </div>
                    </div>
                </div>

                <h1 class="text-2xl md:text-4xl font-bold text-white mb-3 text-center">DSA Master</h1>
                <p class="text-gray-400 text-sm max-w-md mx-auto text-center px-4 mb-8">
                    Ask for solutions in Python, Java, C++, or Go.<br>
                    Includes logic, complexity analysis & diagrams.
                </p>

                <div class="flex flex-wrap justify-center gap-2">
                    <button onclick="fillInput('Explain Linked List in English')" class="px-4 py-2 rounded-full border border-border bg-surface hover:bg-white/10 text-xs text-gray-300 transition">üìö Explain Linked List</button>
                    <button onclick="fillInput('Binary Search in Python')" class="px-4 py-2 rounded-full border border-border bg-surface hover:bg-white/10 text-xs text-gray-300 transition">üêç Python Search</button>
                    <button onclick="fillInput('Merge Sort C++')" class="px-4 py-2 rounded-full border border-border bg-surface hover:bg-white/10 text-xs text-gray-300 transition">‚öôÔ∏è C++ Sort</button>
                </div>
            </div>

            <div id="messages-list" class="space-y-6 pb-24"></div>

            <div id="loader" class="hidden pb-24">
                <div class="flex gap-4">
                    <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center flex-shrink-0"><i class="ri-robot-2-fill text-white"></i></div>
                    <div class="flex items-center gap-1 mt-3">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full bg-bg border-t border-white/5 p-3 md:p-4 z-30">
        <div class="max-w-3xl mx-auto relative">
            
            <div id="file-preview" class="hidden absolute -top-12 left-0 bg-surface border border-border px-3 py-1.5 rounded text-xs text-gray-400 items-center gap-2 shadow-lg">
                <i class="ri-file-code-line"></i> 
                <span id="filename" class="truncate max-w-[150px]">file.js</span>
                <button onclick="clearFile()" class="ml-2 hover:text-red-400 p-1"><i class="ri-close-line"></i></button>
            </div>

            <div class="bg-surface rounded-xl border border-border flex items-end p-2 shadow-lg focus-within:border-blue-500/50 transition-colors">
                <button onclick="document.getElementById('file-upload').click()" class="p-2 text-gray-400 hover:text-white rounded-lg transition shrink-0" title="Attach Code/Image"><i class="ri-attachment-2 text-xl"></i></button>
                <input type="file" id="file-upload" class="hidden" onchange="handleFile(this)">

                <textarea id="user-input" rows="1" class="w-full bg-transparent text-white placeholder-gray-500 p-2.5 max-h-32 resize-none focus:outline-none font-sans text-base" placeholder="Ask CodeMate about DSA..."></textarea>

                <button onclick="sendMessage()" id="send-btn" class="p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition shadow-lg shrink-0"><i class="ri-arrow-up-line font-bold text-xl"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- INITIALIZATION ---
        // Initialize Mermaid for diagrams
        mermaid.initialize({ startOnLoad: false, theme: 'dark' });

        // Typewriter Effect Variables
        const languages = ["Python...", "C++...", "Java...", "JS..."];
        let langIndex = 0, charIndex = 0, isDeleting = false;

        // --- TYPEWRITER EFFECT FUNCTION ---
        function typeWriter() {
            const currentLang = languages[langIndex];
            const typeElement = document.getElementById("typewriter");
            if (!typeElement) return;

            typeElement.innerText = isDeleting ? currentLang.substring(0, charIndex--) : currentLang.substring(0, charIndex++);
            
            let speed = isDeleting ? 50 : 100;
            if (!isDeleting && charIndex === currentLang.length + 1) { isDeleting = true; speed = 2000; }
            else if (isDeleting && charIndex === 0) { isDeleting = false; langIndex = (langIndex + 1) % languages.length; }

            setTimeout(typeWriter, speed);
        }
        document.addEventListener("DOMContentLoaded", typeWriter);

        // --- CHAT & UI LOGIC ---
        const chatContainer = document.getElementById('chat-container');
        const msgList = document.getElementById('messages-list');
        const userInput = document.getElementById('user-input');
        const hero = document.getElementById('hero');
        const loader = document.getElementById('loader');
        let currentFile = null;

        // Auto-resize textarea
        userInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // Handle Enter key to send
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        // Helper to fill input from buttons
        function fillInput(text) { userInput.value = text; userInput.focus(); userInput.dispatchEvent(new Event('input')); }

        // Handle File Selection
        function handleFile(input) {
            if (input.files[0]) {
                currentFile = input.files[0];
                document.getElementById('file-preview').classList.replace('hidden', 'flex');
                document.getElementById('filename').innerText = currentFile.name;
            }
        }

        // Clear Selected File
        function clearFile() {
            currentFile = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('file-preview').classList.replace('flex', 'hidden');
        }

        // Append Message to Chat Window
        function appendMessage(role, content) {
            const div = document.createElement('div');
            div.className = "flex gap-4 animate-fade-in";
            
            // Avatar Icons
            const avatarHtml = role === 'ai' 
                ? '<div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center flex-shrink-0 mt-1"><i class="ri-robot-2-fill text-white"></i></div>'
                : '<div class="w-8 h-8 rounded bg-surface border border-border flex items-center justify-center flex-shrink-0 mt-1"><i class="ri-user-3-fill text-gray-300"></i></div>';

            const msgContent = document.createElement('div');
            msgContent.className = "flex-1 min-w-0 prose prose-invert max-w-none pt-1";

            if (role === 'ai') {
                // Parse Markdown
                msgContent.innerHTML = marked.parse(content);
                
                // Process Code Blocks and Diagrams
                msgContent.querySelectorAll('pre code').forEach((block) => {
                    const rawCode = block.innerText;
                    const lang = block.className.replace('language-', '') || 'text';

                    // 1. Render Mermaid Diagrams
                    if (lang === 'mermaid') {
                        const diagramDiv = document.createElement('div');
                        diagramDiv.className = "mermaid bg-black/30 p-4 rounded-lg border border-border my-4 overflow-x-auto text-center";
                        diagramDiv.textContent = rawCode;
                        block.parentElement.replaceWith(diagramDiv);
                        return;
                    }

                    // 2. Render Standard Code Blocks with Copy Button
                    const container = document.createElement('div');
                    container.className = 'code-container';
                    
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    header.innerHTML = `
                        <span class="font-mono text-xs uppercase text-blue-400">${lang}</span>
                        <div class="copy-btn text-xs text-gray-400 hover:text-white" onclick="copyCode(this)">
                            <i class="ri-file-copy-line"></i> <span>Copy</span>
                        </div>
                        <textarea class="hidden hidden-code">${rawCode}</textarea>
                    `;

                    const pre = document.createElement('pre');
                    const codeEl = document.createElement('code');
                    codeEl.className = `language-${lang}`;
                    codeEl.textContent = rawCode;
                    
                    pre.appendChild(codeEl);
                    container.appendChild(header);
                    container.appendChild(pre);
                    block.parentElement.replaceWith(container);
                    
                    // Apply Syntax Highlighting
                    hljs.highlightElement(codeEl);
                });

                // Render Math (LaTeX)
                renderMathInElement(msgContent, { delimiters: [{ left: "$$", right: "$$", display: true }, { left: "$", right: "$", display: false }] });
                
                // Initialize Mermaid
                mermaid.run({ nodes: msgContent.querySelectorAll('.mermaid') });

            } else {
                // User Message Rendering
                msgContent.innerHTML = `<p class="whitespace-pre-wrap text-gray-200">${content}</p>`;
                if (currentFile) msgContent.innerHTML += `<div class="mt-2 text-xs text-blue-400 bg-blue-500/10 inline-block px-2 py-1 rounded border border-blue-500/20"><i class="ri-attachment-2"></i> ${currentFile.name}</div>`;
            }

            div.innerHTML = avatarHtml;
            div.appendChild(msgContent);
            msgList.appendChild(div);
            
            // Auto Scroll to Bottom
            setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50);
        }

        // Function to Copy Code to Clipboard
        window.copyCode = function (btn) {
            const area = btn.parentElement.querySelector('.hidden-code');
            if (!area) return;
            navigator.clipboard.writeText(area.value).then(() => {
                const span = btn.querySelector('span');
                const icon = btn.querySelector('i');
                const originalText = span.innerText;
                
                span.innerText = "Copied!";
                icon.className = "ri-check-line text-green-400";
                
                setTimeout(() => {
                    span.innerText = originalText;
                    icon.className = "ri-file-copy-line";
                }, 2000);
            }).catch(err => console.error('Copy failed:', err));
        }

        // Main Send Function
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !currentFile) return;

            // Hide Hero Section on first message
            if (hero) hero.style.display = 'none';
            appendMessage('user', text);
            
            // Reset Input UI
            userInput.value = '';
            userInput.style.height = 'auto';
            document.getElementById('send-btn').disabled = true;

            // Prepare Form Data
            const formData = new FormData();
            formData.append('message', text);
            if (currentFile) formData.append('file', currentFile);
            clearFile();

            // Show Loader
            loader.classList.remove('hidden');
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // Send Request to Backend
                const res = await fetch('/chat', { method: 'POST', body: formData });
                const data = await res.json();
                loader.classList.add('hidden');

                if (data.error) {
                    appendMessage('ai', `‚ö†Ô∏è **Error:** ${data.error}`);
                } else {
                    appendMessage('ai', data.response);
                }
            } catch (err) {
                loader.classList.add('hidden');
                appendMessage('ai', `‚ùå **Connection Error:** Could not connect to the backend. Please ensure 'app.py' is running.`);
                console.error(err);
            } finally {
                document.getElementById('send-btn').disabled = false;
                // Keep focus on input for desktop users
                if(window.innerWidth > 768) userInput.focus();
            }
        }
    </script>
</body>
</html>

